echo "ğŸ³ Checking Docker containers..."

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
    echo "âŒ Docker is not running. Please start Docker and try again."
    exit 1
fi

# Check if containers are running, if not start them
if ! docker ps | grep -q "postgres"; then
    echo "ğŸš€ Starting Docker containers..."
    docker compose up -d
    
    echo "â³ Waiting for PostgreSQL to be ready..."
    until docker exec dbnexus-ecommerce-dev pg_isready -U demo > /dev/null 2>&1; do
        sleep 1
    done
    
    echo "â³ Waiting for MySQL to be ready..."
    until docker exec dbnexus-blog mysqladmin ping -h localhost -u demo -pdemo123 --silent > /dev/null 2>&1; do
        sleep 1
    done
    
    echo "âœ… All databases are ready!"
fi

echo "ğŸ§¹ Cleaning test database and cache..."
rm -rf apps/api/.dbnexus
rm -rf apps/api/node_modules/.cache

echo "ğŸ§ª Running integration tests before push..."
if pnpm test:integration; then
    echo "âœ… All integration tests passed!"
else
    echo "âš ï¸  Some integration tests failed, but push will continue."
    echo "ğŸ’¡ Run 'pnpm test:integration' locally to debug failing tests."
fi
