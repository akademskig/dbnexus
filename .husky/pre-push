echo "ğŸ³ Checking Docker containers..."

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
    echo "âŒ Docker is not running. Please start Docker and try again."
    exit 1
fi

# Check if containers are running, if not start them
if ! docker ps | grep -q "postgres"; then
    echo "ğŸš€ Starting Docker containers..."
    docker compose up -d
    echo "â³ Waiting for databases to be ready..."
    sleep 5
fi

echo "ğŸ§¹ Cleaning test database and cache..."
rm -rf apps/api/.dbnexus
rm -rf apps/api/node_modules/.cache

echo "ğŸ§ª Running integration tests before push..."
pnpm test:integration || {
    echo "âŒ Integration tests failed."
    exit 1
}

echo "âœ… All integration tests passed!"
